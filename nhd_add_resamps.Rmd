---
title: "nhdplus_add_in"
author: "Josh Erickson"
date: "June 10, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)
library(caret)
library(reshape2)
library(tidyverse)
```

Adding in the NHDPlus data with the resampled locations in the tuning process so we can compare metrics by resample. This is a lot of tedius work but ultimately getting the 'models' all together by CV method.


```{r}

train <- read_csv("train.csv") %>% mutate(across(where(is.character), factor))
#now get points from train data and extract
trainPTS <- st_as_sf(train, coords = c("utm1","utm2"))

st_crs(trainPTS) <- "+proj=aea +lat_1=46 +lat_2=48 +lat_0=44 +lon_0=-109.5 +x_0=600000 +y_0=0 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0"

#now give the 0's"X0" and the values "X1"
train$NHDPlus <- ifelse(train$NHDPlus == 0, "X1", "X2")

train$NHDPlus <- factor(train$NHDPlus)

#now we have baseline data associated with the points used in the models

#now get the best tune to filter
Ktune80$bestTune
Ktune40$bestTune
KtunenoSD$bestTune
```

```{r}

#now collect resample locations from each tuning process
resamples.tune80 <-  Ktune80$pred %>% filter(mtry == 2, ntree == 600, threshold == 0.44)
resamples.tune40 <-  Ktune40$pred %>% filter(mtry == 2, ntree == 1800, threshold == 0.52)
resamples.tunenoSD <-  KtunenoSD$pred %>% filter(mtry == 3, ntree == 600, threshold == 0.5)

#add common identifier to training set
train$X <- seq(1,6602,1)

#now the resamples
colnames(resamples.tune80)[2] <- "X"

#now join for the CV80
join_resamp80 <- left_join(resamples.tune80,train,  by = "X" )

####  do for the others ###

#now for the LLOCV
colnames(resamples.tune40)[2] <- "X"

#now join
join_resamp40 <- left_join(resamples.tune40,train,    by = "X" )

#now the no spatial dependance "SD80"
colnames(resamples.tunenoSD)[2] <- "X"

#now join
join_resampnoSD <- left_join(resamples.tunenoSD,train,  by = "X" )

```

Now we can select the resampled prediction, observations, NHDPlus and resample id.

```{r}
nhdtune80 <- join_resamp80 %>% select(Resample, obs, pred, X1, NHDPlus)
nhdtune40 <- join_resamp40 %>% select(Resample, obs, pred, X1, NHDPlus)
nhdtunenoSD <- join_resampnoSD %>% select(Resample, obs, pred, X1, NHDPlus)
```

Now this allows us to run summary statistics on each of the model types, including the NHDPlus response.

```{r}
#create a function to capture the NHDPlus summary stats
#now we can run the stats on it.
twoClassSummaryNHD <- function (data, lev = NULL, model = NULL) 
{
    rocObject <- pROC::roc(as.numeric(data$obs), as.numeric(data$NHDPlus))
    
    rocAUC <- rocObject$auc
    
    out <- c(rocAUC, sensitivity(data[, "NHDPlus"], data[, "obs"], 
        lev[1]), specificity(data[, "NHDPlus"], data[, "obs"], lev[2]))
    names(out) <- c("ROC", "Sens", "Spec")
    out
}
fourStatsNhdtune <-  function(dat) {
  out <- c(twoClassSummaryNHD(dat, lev = levels(dat$obs), model = NULL))
  tab <- caret::confusionMatrix(dat$NHDPlus, dat$obs,
                                positive = levels(dat$obs)[1])
  res <- c(tab$byClass, tab$overall[c("Accuracy", "Kappa")])
  res <- c(res,
           res["Sensitivity"] + res["Specificity"] - 1,
           sqrt((res["Sensitivity"] - 1) ^ 2 + (res["Specificity"] - 1) ^ 2))
  names(res)[-seq_len(length(res) - 2)] <- c("J", "Dist")
  list(out,res)
  
}
```

Now we can run the summary stats on each Resample (group). Start with the 80 cluster.

```{r}


blah <- nhdtune80 %>% base::split(.$Resample) %>% map(fourStatsNhdtune)

blah_names <- data.frame(Resample = names(blah))

blah <- blah %>% map_df(unlist)

blah <- cbind(blah_names, blah)

blah <- blah %>% pivot_longer(-Resample, names_to = "Metric")

blah$Metric<- paste0("NHDPlus~",blah$Metric)

blah<- blah %>% pivot_wider(names_from = "Metric")

#the resamples function does the same thing but doesn't handle 'non-caret' objects
#thus we only use the models we used caret on.

resamps80 <- resamples(list(
                          Topoclimatic = Ktune80,
                          TopoOnly = Ktune80_topo))

#now we can join the NHDPlus results with the topoclimatic and topo-only models

resamps80$values <- plyr::join(blah, resamps80$values, by = "Resample")

resamps80$methods$NHDPlus <- "custom"

resamps80$models <- c("Topoclimatic", "TopoOnly", "NHDPlus")

summary(resamps80, resamples = "final", metric = "J")
```

Now we can create a long data frame and clean up the joining we did above. This will make it easier to plot.

```{r}

plotting_80 <- resamps80$values %>% pivot_longer(cols = -Resample, names_to = "Metric") 

temp <- strsplit(plotting_80$Metric, "~")

mat <- matrix(unlist(temp), ncol = 2, byrow = TRUE)
df <- as.data.frame(mat)

plotting_80 <- cbind(plotting_80[,c(1,3)], df)
colnames(plotting_80)[3] <- "model"
colnames(plotting_80)[4] <- "metric"


```


Now do the same for the LLO, except we won't use twoSummarystats function due to ROC being finicky with insufficient values, i.e. LLO is prone to this since you're only testing with minimal data.


```{r}


blah2 <- nhdtune40 %>% base::split(.$Resample) %>% map(fourStatsNhdtune)

blah_names2 <- data.frame(Resample = names(blah2))

blah2 <- blah2 %>% map_df(unlist)

blah2 <- cbind(blah_names2, blah2)

blah2 <- blah2 %>% pivot_longer(-Resample, names_to = "Metric")

blah2$Metric<- paste0("NHDPlus~",blah2$Metric)

blah2<- blah2 %>% pivot_wider(names_from = "Metric")

resamps40 <- resamples(list(
                          Topoclimatic = Ktune40,
                          TopoOnly = Ktune40_topo))

resamps40$values <- plyr::join(blah2, resamps40$values, by = "Resample")

resamps40$methods$NHDPlus <- "custom"

resamps40$models <- c("Topoclimatic", "TopoOnly", "NHDPlus")

summary(resamps40, resamples = "final", metric = "J")

```

Now clean up LLO for plotting.

```{r}

plotting_40 <- resamps40$values %>% pivot_longer(cols = -Resample, names_to = "Metric") 

temp <- strsplit(plotting_40$Metric, "~")

mat <- matrix(unlist(temp), ncol = 2, byrow = TRUE)
df <- as.data.frame(mat)

plotting_40 <- cbind(plotting_40[,c(1,3)], df)
colnames(plotting_40)[3] <- "model"
colnames(plotting_40)[4] <- "metric"


```


Now we can do the final join of NHDPlus and the models. This will be for the random CV with no dependance structure.


```{r}


blah3 <- nhdtunenoSD %>% base::split(.$Resample) %>% map(fourStatsNhdtune)

blah_names3 <- data.frame(Resample = names(blah3))

blah3 <- blah3 %>% map_df(unlist)

blah3 <- cbind(blah_names3, blah3)

blah3 <- blah3 %>% pivot_longer(-Resample, names_to = "Metric")

blah3$Metric<- paste0("NHDPlus~",blah3$Metric)

blah3<- blah3 %>% pivot_wider(names_from = "Metric")

resampsnoSD <- resamples(list(
                          Topoclimatic = KtunenoSD,
                          TopoOnly = KtunenoSD_topo))

resampsnoSD$values <- plyr::join(blah3, resampsnoSD$values, by = "Resample")

resampsnoSD$methods$NHDPlus <- "custom"

resampsnoSD$models <- c("Topoclimatic", "TopoOnly", "NHDPlus")

summary(resampsnoSD, resamples = "final", metric = "J")

```

And, clean up for plotting.

```{r}

noSD_plotting <- resampsnoSD$values %>% pivot_longer(cols = -Resample, names_to = "Metric") 

temp <- strsplit(noSD_plotting$Metric, "~")

mat <- matrix(unlist(temp), ncol = 2, byrow = TRUE)
df <- as.data.frame(mat)

noSD_plotting<- cbind(noSD_plotting[,c(1,3)], df)
colnames(noSD_plotting)[3] <- "model"
colnames(noSD_plotting)[4] <- "metric"


```

