---
title: "tuning"
author: "Josh Erickson"
date: "April 15, 2020"
output: html_document
---

```{r setup, include=FALSE}
library(sp)
library(sf)
library(rgdal)
library(rgeos)
library(raster)
library(automap)
library(caret)
library(CAST)

```

Now tune the variables from the feature selection.


Kmeans Random Forest Tune ffs

```{r, eval=FALSE}


ffsK80$selectedvars

levels(train$stream) <- c("X0", "X1")

library(recipes)

rec_Ktune80 <-   recipe(stream ~ ., data = train) %>% 
  update_role(-stream,-accum30,-tpi30agg,-vv30agg,
              -nppmmid30agg, -deficitRS, -decid30RS, -NDVI_med, new_role = "bring along")





cluster <- makeCluster(detectCores() - 1) # convention to leave 1 core for OS
registerDoParallel(cluster)

set.seed(1234)
Ktune80 <- train(rec_Ktune80, data = train,
              method = thresh_code,
              metric = "J",
              tuneGrid = expand.grid(mtry = 2:6,ntree=seq(400,2000,200),
                                     threshold = seq(.40,.60,.02)),
              trControl = trainControl(method = "repeatedcv",
                                       repeats = 5,
                                       classProbs = TRUE,
                                       savePredictions = 'all',
                                       index = indicesKtrain80$index,
                                       summaryFunction = fourStats))

stopCluster(cluster)
registerDoSEQ()

```

```{r echo=FALSE, message=FALSE, fig.align='center', fig.height=16, fig.width=13}

confusionMatrix(Ktune80,norm = "none")

Ktune80$finalModel$confusion

results <- Ktune80$results 
results %>% filter(mtry == 2, ntree == 600, threshold == 0.5)
```

Now just run a LLO alone model; ffs

```{r}


library(recipes)

ffsK_LLO80$selectedvars

rec_tuneLLO80 <-   recipe(stream ~ ., data = train) %>% 
  update_role(-stream,-accum30,-tpi30agg,-npol30agg, -NDVI_med,
              -decid30RS, new_role = "bring along")


cluster <- makeCluster(detectCores() - 1) # convention to leave 1 core for OS
registerDoParallel(cluster)

set.seed(1234)
KtuneLLO80 <- train(rec_tuneLLO80, data = train,
              method = thresh_code,
              metric = "J",
              tuneGrid = expand.grid(mtry = 2:4,ntree=seq(400,2000,200),
                                     threshold = seq(.4,.6,.02)),
              trControl = trainControl(method = "repeatedcv",
                                       repeats = 5,
                                       classProbs = TRUE,
                                       savePredictions = 'all',
                                       index = indicesKtrainLLO80$index,
                                       summaryFunction = fourStats))

stopCluster(cluster)
registerDoSEQ()
KtuneLLO80$finalModel$importance
KtuneLLO80$finalModel$tuneValue
Ktune80$finalModel$importance
confusionMatrix.train(ffsTopo.hw,norm = "none")
```

Now just run a random cv model; ffs

```{r}


library(recipes)

ffsK_noSD$selectedvars

rec_tunenoSD80 <-   recipe(stream ~ ., data = train) %>% 
  update_role(-stream,-accum30,-tpi30agg,-vv30agg, -nppmmid30agg,-decid30RS,
              -cad30RS, -cpg30precip, -deficitRS, -NDVI_med, new_role = "bring along")


cluster <- makeCluster(detectCores() - 1) # convention to leave 1 core for OS
registerDoParallel(cluster)

set.seed(1234)
KtunenoSD80 <- train(rec_tunenoSD80, data = train,
              method = thresh_code,
              metric = "J",
              tuneGrid = expand.grid(mtry = 2:8,ntree=seq(400,2000,200),
                                     threshold = seq(.4,.6,.02)),
              trControl = trainControl(method = "repeatedcv",
                                       repeats = 5,
                                       classProbs = TRUE,
                                       savePredictions = 'all',
                                       summaryFunction = fourStats))

stopCluster(cluster)
registerDoSEQ()

plot(KtunenoSD80)
confusionMatrix.train(KtunenoSD80,norm = "none")
```



Now Kmeans Random Forest Tune topography only

```{r, eval=FALSE}

library(recipes)

rec_Ktune80_topo <-   recipe(stream ~ ., data = train) %>% 
  update_role(-stream,-accum30,-twi30agg, -tpi30agg, new_role = "bring along")

cluster <- makeCluster(detectCores() - 1) # convention to leave 1 core for OS
registerDoParallel(cluster)

set.seed(1234)
Ktune80_topo <- train(rec_Ktune80_topo, data = train,
              method = thresh_code,
              metric = "J",
              tuneGrid = expand.grid(mtry = 2,ntree=seq(400,2000,200),
                                     threshold = seq(.40,.60,.02)),
              trControl = trainControl(method = "repeatedcv",
                                       repeats = 5,
                                       classProbs = TRUE,
                                       savePredictions = 'all',
                                       index = indicesKtrain80$index,
                                       summaryFunction = fourStats))

stopCluster(cluster)
registerDoSEQ()

```

```{r echo=FALSE, message=FALSE, fig.align='center', fig.height=16, fig.width=13}

confusionMatrix(Ktune80,norm = "none")
Ktune80$finalModel$confusion
results <- Ktune80$results
results %>% filter(mtry == 2, ntree == 1000, threshold == 0.48)
```

Now just run a LLO topography alone model

```{r}


library(recipes)

rec_tuneLLO80_topo <-   recipe(stream ~ ., data = train) %>% 
  update_role(-stream,-accum30,-twi30agg, -tpi30agg,new_role = "bring along")


cluster <- makeCluster(detectCores() - 1) # convention to leave 1 core for OS
registerDoParallel(cluster)

set.seed(1234)
KtuneLLO80_topo <- train(rec_tuneLLO80_topo, data = train,
              method = thresh_code,
              metric = "J",
              tuneGrid = expand.grid(mtry = 2,ntree=seq(400,2000,200),
                                     threshold = seq(.4,.6,.02)),
              trControl = trainControl(method = "repeatedcv",
                                       repeats = 5,
                                       classProbs = TRUE,
                                       savePredictions = 'all',
                                       index = indicesKtrainLLO80$index,
                                       summaryFunction = fourStats))

stopCluster(cluster)
registerDoSEQ()
KtuneLLO80$finalModel$importance
KtuneLLO80$finalModel$tuneValue
Ktune80$finalModel$importance
confusionMatrix.train(ffsTopo.hw,norm = "none")
```

Now just run a random cv topography only model

```{r}


library(recipes)

rec_tunenoSD80_topo <-   recipe(stream ~ ., data = train) %>% 
  update_role(-stream,-accum30,-tpi30agg, new_role = "bring along")


cluster <- makeCluster(detectCores() - 1) # convention to leave 1 core for OS
registerDoParallel(cluster)

set.seed(1234)
KtunenoSD80_topo <- train(rec_tunenoSD80_topo, data = train,
              method = thresh_code,
              metric = "J",
              tuneGrid = expand.grid(mtry = 2,ntree=seq(400,2000,200),
                                     threshold = seq(.4,.6,.02)),
              trControl = trainControl(method = "repeatedcv",
                                       repeats = 5,
                                       classProbs = TRUE,
                                       savePredictions = 'all',
                                       summaryFunction = fourStats))

stopCluster(cluster)
registerDoSEQ()

resamples.tune80 %>% group_by(Resample) %>% mutate(pred_right = ifelse(pred == obs, 1, 0)) %>% 
                                                   summarise(pred_rate = sum(pred_right)/n())
plot(KtunenoSD80)
confusionMatrix.train(KtunenoSD80,norm = "none")
```



