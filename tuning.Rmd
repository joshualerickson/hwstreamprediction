---
title: "tuning"
author: "Josh Erickson"
date: "April 15, 2020"
output: html_document
---

```{r setup, include=FALSE}
library(caret)
library(CAST)
library(recipes)
library(tidyverse)
library(doParallel)
library(parallel)
```

Now tune the variables from the feature selection.

```{r}
train <- read_csv("train.csv") %>% mutate(across(where(is.character), factor))
```

After you run the ffs you just need the feature selections; if you want to save space you can just keep the names and delete the ffs models.

```{r, eval = FALSE}
ffsK80_names <- ffsK80$selectedvars

ffsK40_names <- ffsK_40$selectedvars

ffsKnoSD_names <- ffsK_noSD$selectedvars
```



Kmeans Random Forest Tune ffs

```{r}

rec_Ktune80 <-   recipe(stream ~ ., data = train) %>% 
  update_role(-stream,-ffsK80_names, new_role = "bring along")

cluster <- makeCluster(detectCores() - 1) # convention to leave 1 core for OS
registerDoParallel(cluster)

set.seed(1234)
Ktune80 <- train(rec_Ktune80, data = train,
              method = thresh_code,
              metric = "J",
              tuneGrid = expand.grid(mtry = 2:6,ntree=seq(400,2000,200),
                                     threshold = seq(.44,.54,.02)),
              trControl = trainControl(method = "repeatedcv",
                                       repeats = 5,
                                       classProbs = TRUE,
                                       savePredictions = 'all',
                                       index = indicesKtrain80$index,
                                       summaryFunction = fourStats))

stopCluster(cluster)
registerDoSEQ()

```

Now just run a 40 cluster model; ffs

```{r}

rec_tune40 <-   recipe(stream ~ ., data = train) %>% 
  update_role(-stream,-ffsK40_names, new_role = "bring along")


cluster <- makeCluster(detectCores() - 1) # convention to leave 1 core for OS
registerDoParallel(cluster)

set.seed(1234)
Ktune40 <- train(rec_tune40, data = train,
              method = thresh_code,
              metric = "J",
              tuneGrid = expand.grid(mtry = 2:8,ntree=seq(400,2000,200),
                                     threshold = seq(.44,.54,.02)),
              trControl = trainControl(method = "repeatedcv",
                                       repeats = 5,
                                       classProbs = TRUE,
                                       savePredictions = 'all',
                                       index = indicesKtrain40$index,
                                       summaryFunction = fourStats))

stopCluster(cluster)
registerDoSEQ()
```

Now just run a random cv model; ffs

```{r}

  
rec_tunenoSD <-   recipe(stream ~ ., data = train) %>% 
  update_role(-stream,-ffsKnoSD_names, new_role = "bring along")

cluster <- makeCluster(detectCores() - 1) # convention to leave 1 core for OS
registerDoParallel(cluster)

set.seed(1234)
KtunenoSD <- train(rec_tunenoSD, data = train,
              method = thresh_code,
              metric = "J",
              tuneGrid = expand.grid(mtry = 2:8,ntree=seq(400,2000,200),
                                     threshold = seq(.44,.54,.02)),
              trControl = trainControl(method = "repeatedcv",
                                       repeats = 5,
                                       classProbs = TRUE,
                                       savePredictions = 'all',
                                       summaryFunction = fourStats))

stopCluster(cluster)
registerDoSEQ()
```



Now Kmeans Random Forest Tune topography only

```{r}

rec_Ktune80_topo <-   recipe(stream ~ ., data = train) %>% 
  update_role(-stream,-accum30,-twi30agg, -tpi30agg, new_role = "bring along")

cluster <- makeCluster(detectCores() - 1) # convention to leave 1 core for OS
registerDoParallel(cluster)

set.seed(1234)
Ktune80_topo <- train(rec_Ktune80_topo, data = train,
              method = thresh_code,
              metric = "J",
              tuneGrid = expand.grid(mtry = 2,ntree=seq(400,2000,200),
                                     threshold = seq(.44,.54,.02)),
              trControl = trainControl(method = "repeatedcv",
                                       repeats = 5,
                                       classProbs = TRUE,
                                       savePredictions = 'all',
                                       index = indicesKtrain80$index,
                                       summaryFunction = fourStats))

stopCluster(cluster)
registerDoSEQ()

```

Now just run a LLO topography alone model

```{r}

rec_tune40_topo <-   recipe(stream ~ ., data = train) %>% 
  update_role(-stream,-accum30,-twi30agg, -tpi30agg,new_role = "bring along")


cluster <- makeCluster(detectCores() - 1) # convention to leave 1 core for OS
registerDoParallel(cluster)

set.seed(1234)
Ktune40_topo <- train(rec_tune40_topo, data = train,
              method = thresh_code,
              metric = "J",
              tuneGrid = expand.grid(mtry = 2,ntree=seq(400,2000,200),
                                     threshold = seq(.44,.54,.02)),
              trControl = trainControl(method = "repeatedcv",
                                       repeats = 5,
                                       classProbs = TRUE,
                                       savePredictions = 'all',
                                       index = indicesKtrain40$index,
                                       summaryFunction = fourStats))

stopCluster(cluster)
registerDoSEQ()
```

Now just run a random cv topography only model

```{r}


library(recipes)

rec_tunenoSD_topo <-   recipe(stream ~ ., data = train) %>% 
  update_role(-stream,-accum30,-tpi30agg, new_role = "bring along")


cluster <- makeCluster(detectCores() - 1) # convention to leave 1 core for OS
registerDoParallel(cluster)

set.seed(1234)
KtunenoSD_topo <- train(rec_tunenoSD_topo, data = train,
              method = thresh_code,
              metric = "J",
              tuneGrid = expand.grid(mtry = 2,ntree=seq(400,2000,200),
                                     threshold = seq(.44,.54,.02)),
              trControl = trainControl(method = "repeatedcv",
                                       repeats = 5,
                                       classProbs = TRUE,
                                       savePredictions = 'all',
                                       summaryFunction = fourStats))

stopCluster(cluster)
registerDoSEQ()

```



